<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.zsyk.crm.manage.mapper.SysRuleBaseRuleMapper">
  <resultMap id="BaseResultMap" type="cn.com.zsyk.crm.manage.entity.SysRuleBaseRule">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="base_rule_id" jdbcType="CHAR" property="baseRuleId" />
    <result column="rule_code" jdbcType="VARCHAR" property="ruleCode" />
    <result column="rule_name" jdbcType="VARCHAR" property="ruleName" />
    <result column="version" jdbcType="INTEGER" property="version" />
    <result column="create_date" jdbcType="VARCHAR" property="createDate" />
    <result column="create_time" jdbcType="VARCHAR" property="createTime" />
    <result column="create_user" jdbcType="VARCHAR" property="createUser" />
    <result column="update_date" jdbcType="VARCHAR" property="updateDate" />
    <result column="update_time" jdbcType="VARCHAR" property="updateTime" />
    <result column="update_user" jdbcType="VARCHAR" property="updateUser" />
    <result column="time_stamp" jdbcType="TIMESTAMP" property="timeStamp" />
    <result column="rec_stat" jdbcType="VARCHAR" property="recStat" />
    <result column="expression" jdbcType="LONGVARCHAR" property="expression" />
    <result column="remark" jdbcType="LONGVARCHAR" property="remark" />
    <result column="isUsed" property="isUsed" jdbcType="VARCHAR" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from sys_rule_base_rule
    where base_rule_id = #{baseRuleId,jdbcType=CHAR}
  </delete>
  <insert id="saveBaseRule" parameterType="cn.com.zsyk.crm.manage.entity.SysRuleBaseRule">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into sys_rule_base_rule (base_rule_id, rule_code, rule_name, 
      version, create_date, create_time, 
      create_user, update_date, update_time, 
      update_user, time_stamp, rec_stat, 
      expression, remark)
    values (#{baseRuleId,jdbcType=CHAR}, #{ruleCode,jdbcType=VARCHAR}, #{ruleName,jdbcType=VARCHAR}, 
      #{version,jdbcType=INTEGER}, #{createDate,jdbcType=VARCHAR}, #{createTime,jdbcType=VARCHAR}, 
      #{createUser,jdbcType=VARCHAR}, #{updateDate,jdbcType=VARCHAR}, #{updateTime,jdbcType=VARCHAR}, 
      #{updateUser,jdbcType=VARCHAR}, #{timeStamp,jdbcType=TIMESTAMP}, #{recStat,jdbcType=VARCHAR}, 
      #{expression,jdbcType=LONGVARCHAR}, #{remark,jdbcType=LONGVARCHAR})
  </insert>
  <update id="updateBaseRule" parameterType="cn.com.zsyk.crm.manage.entity.SysRuleBaseRule">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update sys_rule_base_rule
    set
      rule_name = #{ruleName,jdbcType=VARCHAR},
      rec_stat = #{recStat,jdbcType=VARCHAR},
      expression = #{expression,jdbcType=LONGVARCHAR},
      update_date = #{updateDate,jdbcType=VARCHAR},
      update_time = #{updateTime,jdbcType=VARCHAR},
      update_user = #{updateUser,jdbcType=VARCHAR},
      remark = #{remark,jdbcType=LONGVARCHAR}
    where base_rule_id = #{baseRuleId,jdbcType=CHAR}
  </update>
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select base_rule_id, rule_code, rule_name, version, create_date, create_time, create_user, 
    update_date, update_time, update_user, time_stamp, rec_stat, expression, remark
    from sys_rule_base_rule
    where base_rule_id = #{baseRuleId,jdbcType=CHAR}
  </select>
  <select id="selectAll" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select base_rule_id, rule_code, rule_name, version, create_date, create_time, create_user, 
    update_date, update_time, update_user, time_stamp, rec_stat, expression, remark
    from sys_rule_base_rule
  </select>
  
    <select id="selectAllByEntity" resultMap="BaseResultMap" parameterType="cn.com.zsyk.crm.manage.entity.SysRuleBaseRule">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select base_rule_id, rule_code, rule_name, version, create_date, create_time, create_user, 
    update_date, update_time, update_user, time_stamp, rec_stat, expression, remark
    from sys_rule_base_rule where 1 = 1
    
    <if test="baseRuleId != null and baseRuleId != ''">
      and base_rule_id = #{baseRuleId}
    </if>
    <if test="ruleCode != null and ruleCode != ''">
      and rule_code = #{ruleCode}
    </if>   
    <if test="ruleName != null and ruleName != ''">
      and rule_name = #{ruleName}
    </if>
    <if test="version != null and version != ''">
      and version = #{version}
    </if>   
    <if test="expression != null and expression != ''">
      and expression = #{expression}
    </if>
    <if test="remark != null and remark != ''">
      and remark = #{remark}
    </if>
  </select>
  
    <select id="findByName" resultType="int"  parameterType="cn.com.zsyk.crm.manage.entity.SysRuleBaseRule">
    select count(0)
    from sys_rule_base_rule
    where rule_name = #{ruleName}
    <if test="baseRuleId != null and baseRuleId != ''">
      and base_rule_id != #{baseRuleId}
    </if>
    and rec_stat = '0'
  </select>
  
    <insert id="saveBaseFactorRel" parameterType="java.util.HashMap" >
    insert into sys_rule_base_factor_rel(id,base_rule_id,factor_order,factor_id,operate,factor_value, create_date, create_time, create_user, update_date, update_time, update_user, time_stamp, rec_stat)
    values(#{id},#{baseRuleId},#{factorOrder},#{factorId},#{operate},#{factorValue},#{createDate,jdbcType=VARCHAR}, #{createTime,jdbcType=VARCHAR}, 
      #{createUser,jdbcType=VARCHAR}, #{updateDate,jdbcType=VARCHAR}, #{updateTime,jdbcType=VARCHAR}, 
      #{updateUser,jdbcType=VARCHAR}, #{timeStamp,jdbcType=TIMESTAMP}, #{recStat,jdbcType=VARCHAR})
  </insert>
  <select id="findAll" resultMap="BaseResultMap" parameterType="cn.com.zsyk.crm.manage.entity.SysRuleBaseRule" >
    SELECT
    t1.base_rule_id, t1.rule_code, t1.rule_name,t1.expression, t1.remark, t1.status, t1.creater, t1.create_time, t1.modifier,
    t1.modify_time,COUNT(t3.combine_rule_name) AS isUsed
    FROM sys_rule_base_rule t1
    LEFT JOIN sys_rule_combine_base_rel t2
    ON t1.base_rule_id = t2.base_rule_id
    LEFT JOIN sys_rule_combine_rule t3
    ON t2.combine_rule_id = t3.combine_rule_id
    AND t3.rec_stat = '0'
    <where>
      <if test="ruleCode != null and ruleCode != ''">
        and t1.rule_code LIKE CONCAT(CONCAT('%',#{ruleCode}),'%' )
      </if>
      <if test="ruleName != null and ruleName != ''">
        and t1.rule_name LIKE CONCAT(CONCAT('%',#{ruleName}),'%' )
      </if>
      and t1.rec_stat = '0'
    </where>
    GROUP BY t1.base_rule_id
    <if test="isUsed == 0">
      HAVING isUsed = 0
    </if>
    <if test="isUsed == 1">
      HAVING isUsed > 0
    </if>
    order by t1.create_time desc
  </select>
  <select id="findBaseRulesByCombineRuleId" resultMap="BaseResultMap" parameterType="java.lang.String" >
    SELECT
    *
    FROM sys_rule_base_rule t1,sys_rule_combine_base_rel t2
    WHERE t1.base_rule_id = t2.base_rule_id
    AND t2.combine_rule_id = #{combineRuleId}
  </select>
  <select id="findById" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select
    *
    from sys_rule_base_rule
    where base_rule_id = #{baseRuleId}
    and rec_stat = '0'
  </select>
  <select id="findBaseFactorRels" resultType="java.util.Map" parameterType="java.lang.String" >
    SELECT
    rel.base_rule_id,factor.factor_name,factor.display_name,rel.factor_order,rel.factor_id,rel.operate,rel.factor_value
    FROM sys_rule_base_factor_rel rel
    LEFT JOIN sys_rule_factor factor ON rel.factor_id = factor.factor_id
    WHERE base_rule_id = #{baseRuleId}
    ORDER BY rel.factor_order ASC
  </select>

    <select id="findByEntity" resultMap="BaseResultMap" parameterType="cn.com.zsyk.crm.manage.entity.SysRuleBaseRule" >
        SELECT
        t1.base_rule_id,
        t1.rule_code,
        t1.rule_name,
        utl_raw.cast_to_varchar2(t1.expression),
        utl_raw.cast_to_varchar2(t1.remark),
        t1.version,
        t1.create_date,
        t1.create_time,
        t1.create_user,
        t1.update_date,
        t1.update_time,
        t1.update_user,
        t1.time_stamp,
        t1.rec_stat,
        COUNT(t3.combine_rule_name) AS isUsed
        FROM sys_rule_base_rule t1
        LEFT JOIN sys_rule_combine_base_rel t2
        ON t1.base_rule_id = t2.base_rule_id
        LEFT JOIN sys_rule_combine_rule t3
        ON t2.combine_rule_id = t3.combine_rule_id
        AND t3.rec_stat = '0'
        <where>
            <if test="ruleCode != null and ruleCode != ''">
                and t1.rule_code LIKE CONCAT(CONCAT('%',#{ruleCode}),'%' )
            </if>
            <if test="ruleName != null and ruleName != ''">
                and t1.rule_name LIKE CONCAT(CONCAT('%',#{ruleName}),'%' )
            </if>
            and t1.rec_stat = '0'
        </where>
        GROUP BY
        t1.base_rule_id,
        t1.rule_code,
        t1.rule_name,
        utl_raw.cast_to_varchar2(t1.expression),
        utl_raw.cast_to_varchar2(t1.remark),
        t1.version,
        t1.create_date,
        t1.create_time,
        t1.create_user,
        t1.update_date,
        t1.update_time,
        t1.update_user,
        t1.time_stamp,
        t1.rec_stat
        <if test="isUsed == 0">
            HAVING isUsed = 0
        </if>
        <if test="isUsed == 1">
            HAVING isUsed > 0
        </if>
        order by t1.create_time desc
    </select>
</mapper>