<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.zsyk.crm.ecif.mapper.EcCustRelationMapper">
  <resultMap id="BaseResultMap" type="cn.com.zsyk.crm.ecif.entity.EcCustRelation">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="cust_no" jdbcType="VARCHAR" property="custNo" />
    
    <id column="relation_typ" jdbcType="VARCHAR" property="relationTyp" />
    <id column="ref_cust_no" jdbcType="VARCHAR" property="refCustNo" />
    
    <id column="sex" jdbcType="VARCHAR" property="sex" />
    <result column="cust_nam" jdbcType="VARCHAR" property="custNam" />
    <result column="ref_cust_nam" jdbcType="VARCHAR" property="refCustNam" />
    
    <result column="relation_desc" jdbcType="VARCHAR" property="relationDesc" />
    <result column="eff_date" jdbcType="VARCHAR" property="effDate" />
    <result column="exp_date" jdbcType="VARCHAR" property="expDate" />
    <result column="rel_end_reason" jdbcType="VARCHAR" property="relEndReason" />
    <result column="ref_cust_no_typ" jdbcType="VARCHAR" property="refCustNoTyp" />
    <result column="create_date" jdbcType="VARCHAR" property="createDate" />
    <result column="create_time" jdbcType="VARCHAR" property="createTime" />
    <result column="create_user" jdbcType="VARCHAR" property="createUser" />
    <result column="update_date" jdbcType="VARCHAR" property="updateDate" />
    <result column="update_time" jdbcType="VARCHAR" property="updateTime" />
    <result column="update_user" jdbcType="VARCHAR" property="updateUser" />
    <result column="time_stamp" jdbcType="TIMESTAMP" property="timeStamp" />
    <result column="rec_stat" jdbcType="VARCHAR" property="recStat" />
    
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from ec_cust_relation
    where cust_no = #{custNo,jdbcType=VARCHAR}
      <if test="relationTyp != null and relationTyp !=''">
          and relation_typ = #{relationTyp,jdbcType=VARCHAR}
      </if>
      <!--and relation_typ = #{relationTyp,jdbcType=VARCHAR}-->
      and ref_cust_no = #{refCustNo,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="cn.com.zsyk.crm.ecif.entity.EcCustRelation">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into ec_cust_relation (cust_no, relation_typ, ref_cust_no, 
      relation_desc, eff_date, exp_date, 
      rel_end_reason, ref_cust_no_typ, create_date, 
      create_time, create_user, update_date, 
      update_time, update_user, time_stamp, 
      rec_stat)
    values (#{custNo,jdbcType=VARCHAR}, #{relationTyp,jdbcType=VARCHAR}, #{refCustNo,jdbcType=VARCHAR},
      #{relationDesc,jdbcType=VARCHAR}, #{effDate,jdbcType=VARCHAR}, #{expDate,jdbcType=VARCHAR}, 
      #{relEndReason,jdbcType=VARCHAR}, #{refCustNoTyp,jdbcType=VARCHAR}, #{createDate,jdbcType=VARCHAR}, 
      #{createTime,jdbcType=VARCHAR}, #{createUser,jdbcType=VARCHAR}, #{updateDate,jdbcType=VARCHAR}, 
      #{updateTime,jdbcType=VARCHAR}, #{updateUser,jdbcType=VARCHAR}, #{timeStamp,jdbcType=TIMESTAMP}, 
      #{recStat,jdbcType=VARCHAR})
  </insert>
  <update id="updateByPrimaryKey" parameterType="cn.com.zsyk.crm.ecif.entity.EcCustRelation">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update ec_cust_relation
    set relation_desc = #{relationDesc,jdbcType=VARCHAR},
      eff_date = #{effDate,jdbcType=VARCHAR},
      exp_date = #{expDate,jdbcType=VARCHAR},
      rel_end_reason = #{relEndReason,jdbcType=VARCHAR},
      ref_cust_no_typ = #{refCustNoTyp,jdbcType=VARCHAR},
      create_date = #{createDate,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=VARCHAR},
      create_user = #{createUser,jdbcType=VARCHAR},
      update_date = #{updateDate,jdbcType=VARCHAR},
      update_time = #{updateTime,jdbcType=VARCHAR},
      update_user = #{updateUser,jdbcType=VARCHAR},
      time_stamp = #{timeStamp,jdbcType=TIMESTAMP},
      rec_stat = #{recStat,jdbcType=VARCHAR}
    where cust_no = #{custNo,jdbcType=VARCHAR}
      and relation_typ = #{relationTyp,jdbcType=VARCHAR}
      and ref_cust_no = #{refCustNo,jdbcType=VARCHAR}
  </update>
  <select id="selectByPrimaryKey" parameterType="map" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select cust_no, relation_typ, ref_cust_no, relation_desc, eff_date, exp_date, rel_end_reason, 
    ref_cust_no_typ, create_date, create_time, create_user, update_date, update_time, 
    update_user, time_stamp, rec_stat
    from ec_cust_relation
    where cust_no = #{custNo,jdbcType=VARCHAR}
      <if test="relationTyp != null and relationTyp !=''">
          and relation_typ = #{relationTyp,jdbcType=VARCHAR}
      </if>
      <!--and relation_typ = #{relationTyp,jdbcType=VARCHAR}-->
      and ref_cust_no = #{refCustNo,jdbcType=VARCHAR}
  </select>
  <select id="selectAll" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select cust_no, relation_typ, ref_cust_no, relation_desc, eff_date, exp_date, rel_end_reason, 
    ref_cust_no_typ, create_date, create_time, create_user, update_date, update_time, 
    update_user, time_stamp, rec_stat
    from ec_cust_relation
  </select>
    <select id="selectCustRelList" parameterType="cn.com.zsyk.crm.ecif.entity.EcCustRelation" resultMap="BaseResultMap">
    select b.cust_nam,a.cust_no, a.relation_typ, a.ref_cust_no, a.relation_desc, a.eff_date, a.exp_date, a.rel_end_reason, 
	    a.ref_cust_no_typ, a.create_date, a.create_time, a.create_user, a.update_date, a.update_time, 
	    a.update_user, a.time_stamp, a.rec_stat
    from ec_cust_relation a ,ec_cust_name b where a.cust_no = b.cust_no
    and  a.rec_stat = '0'
    <if test="custNo != null and custNo !=''">
				and a.cust_no = #{custNo,jdbcType=VARCHAR}
			</if>
			<if test="relationTyp != null and relationTyp !=''">
				and a.relation_typ = #{relationTyp,jdbcType=VARCHAR}
			</if>
        <if test="custNam != null and custNam !=''">
            and b.cust_nam like '${custNam}%'
        </if>
  </select>
  <delete id="deleteByCustNo"  parameterType="java.lang.String">
    delete from ec_cust_relation
    where cust_no = #{custNo,jdbcType=VARCHAR}
  </delete>
  
   <select id="selectReverseCustRelation" parameterType="cn.com.zsyk.crm.ecif.entity.EcCustRelation" resultMap="BaseResultMap">
   <!-- a.relation_typ,			a.relation_desc,c.forward_relation, -->
	    SELECT
			c.reverse_relation relation_typ
		FROM
			ec_cust_relation a,
			ec_cust_per b,
			ec_relation_data c
		WHERE
			a.cust_no = b.cust_no
		AND a.relation_typ = c.forward_relation
		AND b.sex = c.sex
	    and b.rec_stat = '0'
	     <if test="custNo != null and custNo !=''">
				and a.cust_no = #{custNo,jdbcType=VARCHAR}
		</if>
		<if test="relationTyp != null and relationTyp !=''">
				and a.relation_typ = #{relationTyp,jdbcType=VARCHAR}
		</if>
  </select>

  <!-- 获取所有图谱人员的关系信息 -->
  <select id="selectRelGraphByCustNoList" parameterType="map" resultMap="BaseResultMap">
			SELECT
				a.cust_no,
				(select n.cust_nam from ec_cust_name n where n.cust_no = a.cust_no) as cust_nam,
				a.relation_typ,
				a.ref_cust_no,
				(select n.cust_nam from ec_cust_name n where n.cust_no = a.ref_cust_no) as ref_cust_nam,
				a.relation_desc
			from ec_cust_relation a
			where 1=1
			<if test="custNoList != null and custNoList.size()>0">
				and a.cust_no in
				<foreach collection="custNoList" index="index" item="item" open="("
					separator="," close=")">
					#{item}
				</foreach>
			</if>
  </select>

	<!-- 获取客户关系图谱人员客户号、姓名信息（去重、包含客户本人） -->
  <select id="selectDistinctRelCustByCustNoList" parameterType="map" resultMap="BaseResultMap">
		select DISTINCT 
			a.ref_cust_no,
			(select b.cust_nam from ec_cust_name b where b.cust_no = a.ref_cust_no) as ref_cust_nam
		from ec_cust_relation a
		where 1=1
				<if test="custNoList != null and custNoList.size()>0">
				and a.cust_no in
				<foreach collection="custNoList" index="index" item="item" open="("
					separator="," close=")">
					#{item}
				</foreach>
			</if>
  </select>
</mapper>