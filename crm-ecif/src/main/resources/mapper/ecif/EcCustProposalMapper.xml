<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.zsyk.crm.ecif.mapper.EcCustProposalMapper">
  <resultMap id="BaseResultMap" type="cn.com.zsyk.crm.ecif.entity.EcCustProposal">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="apply_order_no" jdbcType="VARCHAR" property="applyOrderNo" />
    <id column="cust_no" jdbcType="VARCHAR" property="custNo" />
    <result column="proposal_no" jdbcType="VARCHAR" property="proposalNo" />
    <result column="pay_cycle" jdbcType="VARCHAR" property="payCycle" />
    <result column="balc_typ" jdbcType="VARCHAR" property="balcTyp" />
    <result column="repl_inden_no" jdbcType="VARCHAR" property="replIndenNo" />
    <result column="aft_disc_pay_fee" jdbcType="DECIMAL" property="aftDiscPayFee" />
    <result column="next_bill_date" jdbcType="VARCHAR" property="nextBillDate" />
    <result column="ttl_amt" jdbcType="DECIMAL" property="ttlAmt" />
    <result column="product_grp" jdbcType="VARCHAR" property="productGrp" />
    <result column="bln_chn" jdbcType="VARCHAR" property="blnChn" />
    <result column="bln_orgn" jdbcType="VARCHAR" property="blnOrgn" />
    <result column="sec_cls_serve_orgnam" jdbcType="VARCHAR" property="secClsServeOrgnam" />
    <result column="inden_agent_flg" jdbcType="VARCHAR" property="indenAgentFlg" />
    <result column="order_pay_addr" jdbcType="VARCHAR" property="orderPayAddr" />
    <result column="sys_inden_no" jdbcType="VARCHAR" property="sysIndenNo" />
    <result column="sys_flg" jdbcType="VARCHAR" property="sysFlg" />
    <result column="wht_ecif_ac_flg" jdbcType="VARCHAR" property="whtEcifAcFlg" />
    <result column="inden_nam" jdbcType="VARCHAR" property="indenNam" />
    <result column="alias_nam" jdbcType="VARCHAR" property="aliasNam" />
    <result column="sign_tm" jdbcType="VARCHAR" property="signTm" />
    <result column="excute_tm" jdbcType="VARCHAR" property="excuteTm" />
    <result column="end_tm" jdbcType="VARCHAR" property="endTm" />
    <result column="inst_inden_flg" jdbcType="VARCHAR" property="instIndenFlg" />
    <result column="trans_last_excute_tm" jdbcType="TIMESTAMP" property="transLastExcuteTm" />
    <result column="inden_end_tm" jdbcType="TIMESTAMP" property="indenEndTm" />
    <result column="inden_end_reason" jdbcType="VARCHAR" property="indenEndReason" />
    <result column="inden_note" jdbcType="VARCHAR" property="indenNote" />
    <result column="inden_sts" jdbcType="VARCHAR" property="indenSts" />
    <result column="inden_typ" jdbcType="VARCHAR" property="indenTyp" />
    <result column="serve_lvl" jdbcType="VARCHAR" property="serveLvl" />
    <result column="inden_last_chk_tm" jdbcType="TIMESTAMP" property="indenLastChkTm" />
    <result column="inden_final_accept_date" jdbcType="VARCHAR" property="indenFinalAcceptDate" />
    <result column="product_flg" jdbcType="VARCHAR" property="productFlg" />
    <result column="index_column" jdbcType="VARCHAR" property="indexColumn" />
    <result column="create_date" jdbcType="VARCHAR" property="createDate" />
    <result column="create_time" jdbcType="VARCHAR" property="createTime" />
    <result column="create_user" jdbcType="VARCHAR" property="createUser" />
    <result column="update_date" jdbcType="VARCHAR" property="updateDate" />
    <result column="update_time" jdbcType="VARCHAR" property="updateTime" />
    <result column="update_user" jdbcType="VARCHAR" property="updateUser" />
    <result column="time_stamp" jdbcType="TIMESTAMP" property="timeStamp" />
    <result column="rec_stat" jdbcType="VARCHAR" property="recStat" />
  </resultMap>

	<!-- 保费/消费次数/首保日期/跟进日期/跟进人 -->
  <resultMap id="SumzResultMap" type="cn.com.zsyk.crm.ecif.bo.cust.CustSumzInfo">
	 <result column="premium" jdbcType="VARCHAR" property="premium" />
    <result column="consumeCnt" jdbcType="VARCHAR" property="consumeCnt" />
    <result column="firstPreDate" jdbcType="VARCHAR" property="firstPreDate" />
    <result column="followUpDate" jdbcType="VARCHAR" property="followUpDate" />
    <result column="followUpUser" jdbcType="VARCHAR" property="followUpUser" />
	</resultMap>

	<!-- 过去一年总保费/数量 -->
	<select id="getTotalPremiumForPastYear" parameterType="map" resultMap="SumzResultMap">
		select nvl(sum(ttl_amt), 0.00) as premium,count(1) as consumeCnt from ec_cust_proposal
		where  cust_no = #{custNo,jdbcType=VARCHAR} 
			and substr(sign_tm,1,4) = to_char(sysdate-1, 'yyyy')
	</select>
	<!-- 总保费/数量 -->
	<select id="getTotalPremium" parameterType="map" resultMap="SumzResultMap">
		select nvl(sum(ttl_amt), 0.00) as premium,count(1) as consumeCnt from ec_cust_proposal
		where  cust_no = #{custNo,jdbcType=VARCHAR} 
	</select>
	<!-- 首保保费/日期 -->
	<select id="getFirtPremium" parameterType="map" resultMap="SumzResultMap">
		select a.ttl_amt as premium,a.sign_tm as firstPreDate from ec_cust_proposal a
		where a.cust_no = #{custNo,jdbcType=VARCHAR} 
		ORDER BY a.ttl_amt asc
	</select>
	<!-- 获取历次保单的保费/日期 按签约日期降序 -->
	<select id="getLastPremium" parameterType="map" resultMap="SumzResultMap">
		select a.ttl_amt as premium,a.sign_tm as firstPreDate from ec_cust_proposal a
		where a.cust_no = #{custNo,jdbcType=VARCHAR} 
		ORDER BY a.sign_tm desc
	</select>

	<select id="getLastFollowUp" parameterType="map" resultMap="SumzResultMap">
		select
			next_follow_up_tm as followUpDate, create_user as followUpUser 
		from ec_track_info where cust_no = #{custNo,jdbcType=VARCHAR} 
			and next_follow_up_tm is not null
			and next_follow_up_tm > sysdate
		ORDER BY next_follow_up_tm ASC
	</select>
  <delete id="deleteByPrimaryKey" parameterType="map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from ec_cust_proposal
    where apply_order_no = #{applyOrderNo,jdbcType=VARCHAR}
      and cust_no = #{custNo,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="cn.com.zsyk.crm.ecif.entity.EcCustProposal">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into ec_cust_proposal (apply_order_no, cust_no, proposal_no, 
      pay_cycle, balc_typ, repl_inden_no, 
      aft_disc_pay_fee, next_bill_date, ttl_amt, 
      product_grp, bln_chn, bln_orgn, 
      sec_cls_serve_orgnam, inden_agent_flg, order_pay_addr, 
      sys_inden_no, sys_flg, wht_ecif_ac_flg, 
      inden_nam, alias_nam, sign_tm, 
      excute_tm, end_tm, inst_inden_flg, 
      trans_last_excute_tm, inden_end_tm, inden_end_reason, 
      inden_note, inden_sts, inden_typ, 
      serve_lvl, inden_last_chk_tm, inden_final_accept_date, 
      product_flg, index_column, create_date, 
      create_time, create_user, update_date, 
      update_time, update_user, time_stamp, 
      rec_stat)
    values (#{applyOrderNo,jdbcType=VARCHAR}, #{custNo,jdbcType=VARCHAR}, #{proposalNo,jdbcType=VARCHAR}, 
      #{payCycle,jdbcType=VARCHAR}, #{balcTyp,jdbcType=VARCHAR}, #{replIndenNo,jdbcType=VARCHAR}, 
      #{aftDiscPayFee,jdbcType=DECIMAL}, #{nextBillDate,jdbcType=VARCHAR}, #{ttlAmt,jdbcType=DECIMAL}, 
      #{productGrp,jdbcType=VARCHAR}, #{blnChn,jdbcType=VARCHAR}, #{blnOrgn,jdbcType=VARCHAR}, 
      #{secClsServeOrgnam,jdbcType=VARCHAR}, #{indenAgentFlg,jdbcType=VARCHAR}, #{orderPayAddr,jdbcType=VARCHAR}, 
      #{sysIndenNo,jdbcType=VARCHAR}, #{sysFlg,jdbcType=VARCHAR}, #{whtEcifAcFlg,jdbcType=VARCHAR}, 
      #{indenNam,jdbcType=VARCHAR}, #{aliasNam,jdbcType=VARCHAR}, #{signTm,jdbcType=VARCHAR}, 
      #{excuteTm,jdbcType=VARCHAR}, #{endTm,jdbcType=VARCHAR}, #{instIndenFlg,jdbcType=VARCHAR}, 
      #{transLastExcuteTm,jdbcType=TIMESTAMP}, #{indenEndTm,jdbcType=TIMESTAMP}, #{indenEndReason,jdbcType=VARCHAR}, 
      #{indenNote,jdbcType=VARCHAR}, #{indenSts,jdbcType=VARCHAR}, #{indenTyp,jdbcType=VARCHAR}, 
      #{serveLvl,jdbcType=VARCHAR}, #{indenLastChkTm,jdbcType=TIMESTAMP}, #{indenFinalAcceptDate,jdbcType=VARCHAR}, 
      #{productFlg,jdbcType=VARCHAR}, #{indexColumn,jdbcType=VARCHAR}, #{createDate,jdbcType=VARCHAR}, 
      #{createTime,jdbcType=VARCHAR}, #{createUser,jdbcType=VARCHAR}, #{updateDate,jdbcType=VARCHAR}, 
      #{updateTime,jdbcType=VARCHAR}, #{updateUser,jdbcType=VARCHAR}, #{timeStamp,jdbcType=TIMESTAMP}, 
      #{recStat,jdbcType=VARCHAR})
  </insert>
  <update id="updateByPrimaryKey" parameterType="cn.com.zsyk.crm.ecif.entity.EcCustProposal">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update ec_cust_proposal
    set proposal_no = #{proposalNo,jdbcType=VARCHAR},
      pay_cycle = #{payCycle,jdbcType=VARCHAR},
      balc_typ = #{balcTyp,jdbcType=VARCHAR},
      repl_inden_no = #{replIndenNo,jdbcType=VARCHAR},
      aft_disc_pay_fee = #{aftDiscPayFee,jdbcType=DECIMAL},
      next_bill_date = #{nextBillDate,jdbcType=VARCHAR},
      ttl_amt = #{ttlAmt,jdbcType=DECIMAL},
      product_grp = #{productGrp,jdbcType=VARCHAR},
      bln_chn = #{blnChn,jdbcType=VARCHAR},
      bln_orgn = #{blnOrgn,jdbcType=VARCHAR},
      sec_cls_serve_orgnam = #{secClsServeOrgnam,jdbcType=VARCHAR},
      inden_agent_flg = #{indenAgentFlg,jdbcType=VARCHAR},
      order_pay_addr = #{orderPayAddr,jdbcType=VARCHAR},
      sys_inden_no = #{sysIndenNo,jdbcType=VARCHAR},
      sys_flg = #{sysFlg,jdbcType=VARCHAR},
      wht_ecif_ac_flg = #{whtEcifAcFlg,jdbcType=VARCHAR},
      inden_nam = #{indenNam,jdbcType=VARCHAR},
      alias_nam = #{aliasNam,jdbcType=VARCHAR},
      sign_tm = #{signTm,jdbcType=VARCHAR},
      excute_tm = #{excuteTm,jdbcType=VARCHAR},
      end_tm = #{endTm,jdbcType=VARCHAR},
      inst_inden_flg = #{instIndenFlg,jdbcType=VARCHAR},
      trans_last_excute_tm = #{transLastExcuteTm,jdbcType=TIMESTAMP},
      inden_end_tm = #{indenEndTm,jdbcType=TIMESTAMP},
      inden_end_reason = #{indenEndReason,jdbcType=VARCHAR},
      inden_note = #{indenNote,jdbcType=VARCHAR},
      inden_sts = #{indenSts,jdbcType=VARCHAR},
      inden_typ = #{indenTyp,jdbcType=VARCHAR},
      serve_lvl = #{serveLvl,jdbcType=VARCHAR},
      inden_last_chk_tm = #{indenLastChkTm,jdbcType=TIMESTAMP},
      inden_final_accept_date = #{indenFinalAcceptDate,jdbcType=VARCHAR},
      product_flg = #{productFlg,jdbcType=VARCHAR},
      index_column = #{indexColumn,jdbcType=VARCHAR},
      create_date = #{createDate,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=VARCHAR},
      create_user = #{createUser,jdbcType=VARCHAR},
      update_date = #{updateDate,jdbcType=VARCHAR},
      update_time = #{updateTime,jdbcType=VARCHAR},
      update_user = #{updateUser,jdbcType=VARCHAR},
      time_stamp = #{timeStamp,jdbcType=TIMESTAMP},
      rec_stat = #{recStat,jdbcType=VARCHAR}
    where apply_order_no = #{applyOrderNo,jdbcType=VARCHAR}
      and cust_no = #{custNo,jdbcType=VARCHAR}
  </update>
  <select id="selectByPrimaryKey" parameterType="map" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select apply_order_no, cust_no, proposal_no, pay_cycle, balc_typ, repl_inden_no, 
    aft_disc_pay_fee, next_bill_date, ttl_amt, product_grp, bln_chn, bln_orgn, sec_cls_serve_orgnam, 
    inden_agent_flg, order_pay_addr, sys_inden_no, sys_flg, wht_ecif_ac_flg, inden_nam, 
    alias_nam, sign_tm, excute_tm, end_tm, inst_inden_flg, trans_last_excute_tm, inden_end_tm, 
    inden_end_reason, inden_note, inden_sts, inden_typ, serve_lvl, inden_last_chk_tm, 
    inden_final_accept_date, product_flg, index_column, create_date, create_time, create_user, 
    update_date, update_time, update_user, time_stamp, rec_stat
    from ec_cust_proposal
    where apply_order_no = #{applyOrderNo,jdbcType=VARCHAR}
      and cust_no = #{custNo,jdbcType=VARCHAR}
  </select>
  <select id="selectAll" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select apply_order_no, cust_no, proposal_no, pay_cycle, balc_typ, repl_inden_no, 
    aft_disc_pay_fee, next_bill_date, ttl_amt, product_grp, bln_chn, bln_orgn, sec_cls_serve_orgnam, 
    inden_agent_flg, order_pay_addr, sys_inden_no, sys_flg, wht_ecif_ac_flg, inden_nam, 
    alias_nam, sign_tm, excute_tm, end_tm, inst_inden_flg, trans_last_excute_tm, inden_end_tm, 
    inden_end_reason, inden_note, inden_sts, inden_typ, serve_lvl, inden_last_chk_tm, 
    inden_final_accept_date, product_flg, index_column, create_date, create_time, create_user, 
    update_date, update_time, update_user, time_stamp, rec_stat
    from ec_cust_proposal
  </select>
   <select id="selectCustProposalList" parameterType="cn.com.zsyk.crm.ecif.entity.EcCustProposal" resultMap="BaseResultMap">
    select apply_order_no, cust_no, proposal_no, pay_cycle, balc_typ, repl_inden_no, 
	    aft_disc_pay_fee, next_bill_date, ttl_amt, product_grp, bln_chn, bln_orgn, sec_cls_serve_orgnam, 
	    inden_agent_flg, order_pay_addr, sys_inden_no, sys_flg, wht_ecif_ac_flg, inden_nam, 
	    alias_nam, sign_tm, excute_tm, end_tm, inst_inden_flg, trans_last_excute_tm, inden_end_tm, 
	    inden_end_reason, inden_note, inden_sts, inden_typ, serve_lvl, inden_last_chk_tm, 
	    inden_final_accept_date, product_flg, index_column, create_date, create_time, create_user, 
	    update_date, update_time, update_user, time_stamp, rec_stat
    from ec_cust_proposal
    where cust_no = #{custNo,jdbcType=VARCHAR} and rec_stat = '0'
			<if test="applyOrderNo != null and applyOrderNo !=''">
				and concat(apply_order_no,proposal_no) like concat('%', #{applyOrderNo,jdbcType=VARCHAR}, '%') 
			</if>
			<if test="secClsServeOrgnam != null and secClsServeOrgnam !=''">
				and sec_cls_serve_orgnam like concat('%', #{secClsServeOrgnam,jdbcType=VARCHAR}, '%') 
			</if>
  </select>
  <delete id="deleteByCustNo"  parameterType="java.lang.String">
    delete from ec_cust_proposal
    where cust_no = #{custNo,jdbcType=VARCHAR}
  </delete>
</mapper>